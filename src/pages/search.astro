---
import "@pagefind/default-ui/css/ui.css";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";

const backUrl = SITE.showBackButton ? `${Astro.url.pathname}` : "/";
---

<Layout title={`Search | ${SITE.title}`} noindex={true}>
  <Header />
  <Main
    pageTitle="Search"
    pageDesc="Search for an article ..."
    singleCard={true}
  >
    <div id="pagefind-search" transition:persist data-backurl={backUrl}></div>
  </Main>
  <Footer />
</Layout>

<script>
  function initSearch() {
    const pageFindSearch: HTMLElement | null =
      document.querySelector("#pagefind-search");

    if (!pageFindSearch) return;

    const params = new URLSearchParams(window.location.search);

    const onIdle = window.requestIdleCallback || (cb => setTimeout(cb, 1));

    onIdle(async () => {
      // @ts-expect-error — Missing types for @pagefind/default-ui package.
      const { PagefindUI } = await import("@pagefind/default-ui");

      // Display warning inn dev mode
      if (import.meta.env.DEV) {
        pageFindSearch.innerHTML = `
            <div class="bg-muted/75 rounded p-4 space-y-4 mb-4">
              <p><strong>DEV mode Warning! </strong>You need to build the project at least once to see the search results during development.</p>
              <code class="block bg-black text-white px-2 py-1 rounded">pnpm run build</code>
            </div>
          `;
      }

      // Init pagefind ui
      const search = new PagefindUI({
        element: "#pagefind-search",
        bundlePath: "/pagefind/",
        showSubResults: true,
        showImages: false,
        processTerm: function (term: string) {
          params.set("q", term); // Update the `q` parameter in the URL
          history.replaceState(history.state, "", "?" + params.toString()); // Push the new URL without reloading

          const backUrl = pageFindSearch?.dataset?.backurl;
          sessionStorage.setItem("backUrl", backUrl + "?" + params.toString());

          return term;
        },
      });

      // If search param exists (eg: search?q=astro), trigger search
      const query = params.get("q");
      if (query) {
        search.triggerSearch(query);
      }

      // Reset search param if search input is cleared
      const searchInput = document.querySelector(".pagefind-ui__search-input");
      const clearButton = document.querySelector(".pagefind-ui__search-clear");
      searchInput?.addEventListener("input", resetSearchParam);
      clearButton?.addEventListener("click", resetSearchParam);

      function resetSearchParam(e: Event) {
        if ((e.target as HTMLInputElement)?.value.trim() === "") {
          history.replaceState(history.state, "", window.location.pathname);
        }
      }
    });
  }

  document.addEventListener("astro:after-swap", () => {
    const pagefindSearch = document.querySelector("#pagefind-search");

    // if pagefind search form already exists, don't initialize search component
    if (pagefindSearch && pagefindSearch.querySelector("form")) return;

    initSearch();
  });
  initSearch();
</script>

<style is:global>
  #pagefind-search {
    --pagefind-ui-font: var(--font-mono);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-tag: var(--background);
    --pagefind-ui-border-radius: 0px;
    --pagefind-ui-border-width: 3px;
    --pagefind-ui-image-border-radius: 0px;
    --pagefind-ui-image-box-ratio: 3 / 2;

    form::before {
      background-color: var(--foreground);
    }

    input {
      font-weight: 700;
      border: 3px solid var(--border) !important;
      box-shadow: 6px 6px 0px var(--shadow-color);
      background-color: var(--background) !important;
      color: var(--foreground) !important;
    }

    input::placeholder {
      color: var(--foreground) !important;
      opacity: 0.4;
    }

    input:focus-visible {
      outline: none;
    }

    .pagefind-ui__message {
      font-family: var(--font-mono);
      font-weight: 700;
      text-transform: uppercase;
      margin-top: 2rem;
      color: var(--foreground);
      border-bottom: 2px solid var(--border);
      padding-bottom: 0.5rem;
    }

    .pagefind-ui__result {
      border-bottom: 3px solid var(--border) !important;
      padding: 2rem 0;
    }

    .pagefind-ui__result-title a {
      color: var(--fizz);
      font-family: var(--font-heading);
      text-transform: uppercase;
      font-weight: 900;
      font-size: 1.5rem;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .pagefind-ui__result-title a:hover {
      color: var(--zest);
      text-decoration: underline;
      text-decoration-thickness: 3px;
      text-underline-offset: 4px;
    }

    .pagefind-ui__result-excerpt {
      color: var(--foreground);
      font-size: 1rem;
      line-height: 1.6;
      margin-top: 0.5rem;
    }

    mark {
      background-color: transparent !important;
      color: var(--zest) !important;
      font-weight: 700;
      text-decoration: underline;
    }

    .pagefind-ui__search-clear {
      background-color: var(--zest) !important;
      color: var(--ink) !important;
      border: 2px solid var(--border) !important;
      border-radius: 0px !important;
      font-weight: 700 !important;
      padding: 0 0.75rem !important;
      height: 2rem !important;
      top: 50% !important;
      right: 1rem !important;
      transform: translateY(-50%) !important;
    }

    .pagefind-ui__result-nested {
      margin-top: 1rem;
      padding-left: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .pagefind-ui__result-nested .pagefind-ui__result-link {
      color: var(--foreground) !important;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.9rem;
      text-decoration: none;
      display: flex;
      align-items: center;
    }

    .pagefind-ui__result-nested .pagefind-ui__result-link::before {
      content: "↳";
      margin-right: 0.5rem;
      color: var(--fizz);
      font-size: 1.2rem;
    }

    .pagefind-ui__result-nested .pagefind-ui__result-link:hover {
      color: var(--fizz) !important;
      text-decoration: underline;
    }

    .pagefind-ui__result:last-of-type {
      border-bottom: 3px solid var(--border) !important;
    }

    .pagefind-ui__button {
      border: 3px solid var(--border) !important;
      box-shadow: 6px 6px 0px var(--shadow-color);
      background-color: var(--card-bg) !important;
      color: var(--foreground) !important;
      font-family: var(--font-heading) !important;
      text-transform: uppercase !important;
      border-radius: 0px !important;
      transition: all 0.2s ease;
    }

    .pagefind-ui__button:hover {
      transform: translate(-2px, -2px);
      box-shadow: 8px 8px 0px var(--shadow-color);
    }
  }
</style>
